# AI 编程错误经验总结 (My Faults)

本文件记录了在进行 Laravel 资源处理器 (Handlers) 迁移和重构过程中犯下的错误，旨在为后续的 AI 编程或协作提供借鉴，避免同类问题再次发生。

## 1. 核心方法更名后的测试遗漏
*   **现象**：将资源处理方法从 `_invoke` 统一更名为 `resolve`。
*   **错误**：仅更新了控制器 (`ResourceController`) 和新编写的测试文件 (`HandlersTest.php`)，但忽略了项目中**既有的旧测试文件** (`BibleProjectTest.php`) 仍然在调用旧方法。
*   **后果**：导致旧测试文件在运行全量测试时报错崩溃。
*   **教训**：重构核心接口（方法名、参数）时，必须全局搜索所有引用，尤其是 `tests/` 目录下的既有测试用例。

## 2. 返回值类型变更导致的断言失效
*   **现象**：为了代码规范化，将 Handler 的返回值从“原始数组”改为 `ResourceResponse` 对象。
*   **错误**：未同步更新旧测试文件中的断言逻辑。旧测试仍然使用 `expect($result)->toBeArray()`，而实际返回的是对象实例。
*   **后果**：测试虽然逻辑运行正确，但断言失败。
*   **教训**：数据结构（Schema）的变更必须伴随测试断言（Assertions）的同步更新。

## 3. 批量替换工具 (`sed`) 的作用域局限性
*   **现象**：将配置路径从 `config('app.services.*')` 迁移到 `config('x-resources.*')`。
*   **错误**：在使用 `sed` 命令进行批量替换时，仅指定了 `app/Resources/Handlers/*.php` 作为目标。
*   **后果**：导致 `tests/` 目录下的测试文件仍然引用旧的配置键，造成测试环境配置读取失败。
*   **教训**：进行全局配置或命名空间变更时，替换工具的作用域应包含 `app/`、`config/` 和 `tests/` 等所有相关目录。

## 4. 验证阶段的“幸存者偏差”
*   **现象**：重构完成后执行 `php artisan test`。
*   **错误**：过于关注自己新写的测试脚本是否通过（全绿），而没有在每次重大变更后手动运行文件夹内的**所有**测试（包括旧有的测试文件）。
*   **后果**：错误被掩盖，直到用户指正才发现回归测试不彻底。
*   **教训**：全量回归测试（Full Regression Testing）是不可省略的步骤。不能仅依靠“增量测试”来判断系统的稳定性。

## 5. 库兼容性假设错误
*   **现象**：在处理网页解析时，默认假设 `HtmlDomParser` 在本地和线上表现一致。
*   **错误**：忽略了本地 PHP 环境与正则引擎可能对特定复杂 HTML 产生的兼容性问题（如 `preg_match` 编译错误）。
*   **后果**：导致部分抓取逻辑（如 `799` 关键词）在本地持续报错。
*   **教训**：在涉及外部网页抓取和复杂正则解析时，应优先考虑使用原生更稳健的解析方式（如手动正则或 DOMDocument），并加强对 Exception 消息的捕获和展示。
